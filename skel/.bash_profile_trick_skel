#!/bin/sh

# trickv's bash_profile skeleton
# Should run on any sh-compatible shell, but realistically probably only bash.

#. $HOME/.trick_skel/sh-functions
#. $HOME/.trick_skel/sh-startup/*
for cur in `find $HOME/.trick_skel/sh-startup/ -type f -perm +7 | grep -v svn`; do
    source $cur
done

export PATH=$HOME/bin:$HOME/bin/trick_skel:$PATH
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
if [ -d $HOME/local/bin ]; then
    export PATH=$HOME/local/bin:$PATH
fi

TRICK_HOSTNAME=`hostname -s`
TRICK_FULL_HOSTNAME=`hostname`

# Handy environment variables that make me happy
export PAGER=less
export EDITOR=vim
export MONO_THEME=clearlooks
# TODO: this is not true on all boxen
export MOZILLA_FIVE_HOME=/usr/lib/seamonkey/
# TODO: this should only be run within certain terminal emulators -- specifically, makes trouble on a linux VT
export PROMPT_COMMAND='echo -ne "\033]0;${USER}@${HOSTNAME%%.*}:${PWD/$HOME/~}\007"'
export CVS_RSH="ssh"
export EMAIL_ADDRESS="trick@vanstaveren.us"
export REAL_NAME="Patrick van Staveren"

# Until mintel gets me a DNS pointer...
atlas=172.17.3.47

# My fancy BASH prompt
# TODO: alternate the color of the username when this is root
# TODO: don't colorize if color isn't available in this terminal.  see system bashrc on any gentoo box
case $TRICK_HOSTNAME in
    anya|willow|sting|baldrick) TRICK_HOSTNAME_COLOR="1;33m";;
    *) TRICK_HOSTNAME_COLOR="1;32m";;
esac
case $UID in
    0) TRICK_USERNAME_COLOR="01;31m";;
    *) TRICK_USERNAME_COLOR="01;37m";;
esac
export PS1="\[\033[${TRICK_USERNAME_COLOR}\]\u\[\033[1;33m\]@\[\033[${TRICK_HOSTNAME_COLOR}\]\h\[\033[1;33m\]:\[\033[01;34m\]\w\[\033[1;31m\]/\[\033[00m\] "
export PS2='>'
unset TRICK_HOSTNAME_COLOR TRICK_USERNAME_COLOR

# Core shell workflow aliases
alias 'ls.'='ls -d .*'
alias l='ls'
alias ll='ls -l'
#alias h='history | tail'
alias h=trick_h
alias j=jobs
alias f=fg
alias u=uptime
alias diff='diff -Nru'
alias nl='nl -ba'

# Application-specific aliases
alias lss='screen -ls'
alias pico='nano -w'
alias nano='nano -w'
alias strdate='date -u +%Y%m%d-%H%M%S'

# Hilarity
alias y='echo Why, you ask? WHY NOT!'
alias ks="echo Learn to type.  You meant ls, right?"
alias dude="echo I AM the dude."

# Conditional stuff
# TODO: nested if required because sh whines...wtf?!
if [ -d $HOME/man ]; then if [ "${MANPATH}" != "" ]; then export MANPATH=$MANPATH:$HOME/man; fi; fi

mysql --version 2>&1 | egrep 'Distrib 5' &> /dev/null
if [ $? -eq 0 ]; then
    # this is MySQL 5, use --show-warnings
    alias mysql='mysql --show-warnings'
fi

trick_append_motd () {
    TRICK_MOTD="${TRICK_MOTD}${1}
"
}

trick_motd () {
    echo -n "$TRICK_MOTD"
}

UNAME=`uname`
if [ "${UNAME}" = "FreeBSD" ]; then
    # FreeBSD-specific stuff goes here!
    alias make=gmake
    export SHELL=/usr/local/bin/bash
    
    # This enables colors with ``ls''
    export CLICOLOR=1

    # w -i sorts by idle time
    alias w='w -i'

    # If this is the default freebsd motd, nuke it.
    egrep '^FreeBSD (6.1|6.2|4.11)-STABLE.*$' /etc/motd &> /dev/null
    if [ $? -eq 0 ]; then
        clear
        trick_append_motd "`head -n 1 /etc/motd`"
    fi
fi

if [ "${UNAME}" = "Linux" ]; then
    # Linux-specific stuff goes here
    # FreeBSD lameness: doesn't support --show-progress.  Perhaps fbsd 7 will have bzip 1.0.4?
    alias bzip2='bzip2 --show-progress'
fi
unset $UNAME

# If we're in a screen session, alias over screen so that we don't end up with a Screen Within A Screen (think: Edgar Allen Poe)
if [ "${TERM}" == "screen" ]; then
    alias 'screen'='echo It appears that you are a masochist. Do not run screen within screen.  It causes cancer.'
fi

# start keychain
trick_skel_start_keychain

# set up proxy as necessary
trick_skel_proxy

# If we have a hostname specific script in ~/.${host}.sh, run it
if [ -f ${HOME}/.${TRICK_FULL_HOSTNAME}.sh ]; then
    echo "Executing machine-specific shell script ${HOME}/.${TRICK_FULL_HOSTNAME}.sh"
    . ${HOME}/.${TRICK_FULL_HOSTNAME}.sh
fi

which colordiff &> /dev/null
if [ $? -eq 0 ]; then
    TRICK_SVN=`which svn`
    alias svn=my_svn
fi

my_svn () {
    # TODO: add handling for when piping to a file? colordiff seems to take care of this
    if [ "${1}" == "diff" ]; then
        $TRICK_SVN $* | colordiff
    else
        IFS=$'\n'
        $TRICK_SVN $*
    fi
}

trick_h () {
    if [ "$1" -gt 0 &> /dev/null ]; then
        !${1}
    else
        history
    fi
}

skelup () {
    OLD_REV=$TRICK_SKEL_ENV_REVISION
    source ~/.bash_profile_trick_skel
    echo "skelup'd from $OLD_REV to $TRICK_SKEL_ENV_REVISION :)"
    unset OLD_REV
}

export TRICK_SKEL_ENV_REVISION=`cat $HOME/.trick_skel_info | grep ^Revision | cut -d\  -f2`

trick_append_motd "`uptime`"
#trick_motd

unset TRICK_HOSTNAME TRICK_FULL_HOSTNAME TRICK_MOTD
