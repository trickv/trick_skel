#!/usr/bin/env bash

# trickv's bash_profile skeleton
# $Id$

TRICK_SKEL_START_TIME=$SECONDS

export PATH=$HOME/bin:$HOME/bin/trick_skel:$PATH

TRICK_HOSTNAME=${HOSTNAME%%.*}
TRICK_FULL_HOSTNAME=$HOSTNAME

# set a common variable to be used to detect if this is a Mintel host
# TODO: figure out how to do this in pure bash?
echo $TRICK_FULL_HOSTNAME | egrep "(atlas|usdmm.com|mintel.co.uk|mintel.ad)" &> /dev/null
if [ $? -eq 0 ]; then
    TRICK_SKEL_MINTEL_HOST=0
else
    TRICK_SKEL_MINTEL_HOST=""
fi

if [ "${OSTYPE/?.?/}" == "freebsd" ]; then
    TRICK_SKEL_IS_FREEBSD=0
else
    TRICK_SKEL_IS_FREEBSD=""
fi

# source all the sh-startup scripts (handled by a previously generated script, initialize)
source $HOME/.trick_skel/initialize

if [ -d $HOME/local/bin ]; then
    export PATH=$HOME/local/bin:$PATH
fi

# Handy environment variables that make me happy
export PAGER=less
export EDITOR=vim
export MONO_THEME=clearlooks
# TODO: this is not true on all boxen
export MOZILLA_FIVE_HOME=/usr/lib/seamonkey/
# TODO: this should only be run within certain terminal emulators -- specifically, makes trouble on a linux VT
export CVS_RSH="ssh"
export EMAIL_ADDRESS="trick@vanstaveren.us"
export REAL_NAME="Patrick van Staveren"

# My fancy BASH prompt
# TODO: alternate the color of the username when this is root
# TODO: don't colorize if color isn't available in this terminal.  see system bashrc on any gentoo box
case $TRICK_HOSTNAME in
    anya|willow|sting|baldrick) TRICK_HOSTNAME_COLOR="1;33m";;
    *) TRICK_HOSTNAME_COLOR="1;32m";;
esac
case $UID in
    0) TRICK_USERNAME_COLOR="01;31m";;
    *) TRICK_USERNAME_COLOR="01;37m";;
esac

# set aliases
trick_skel_aliases

# FreeBSD-specific stuff goes here!
if [ $TRICK_SKEL_IS_FREEBSD ]; then
    # If this is a FreeBSD jail host, try and determine the jail host name
    dbg "Trying to detrmine jail host name..."
    JAIL_HOST=`jailhost`
    dbg "Jail host is '${JAIL_HOST}'"
    if [ "${JAIL_HOST}" != "${TRICK_HOSTNAME}"  -a "${JAIL_HOST}" ]; then
        dbg "We're inside a jail, so setting prompt"
        JAIL_HOST_INSERT="[${JAIL_HOST}]"
        case $JAIL_HOST in
            mustang|camaro|roadrunner|willow|anya)
                TRICK_HOSTNAME_COLOR="1;33m";;
        esac
    else
        dbg "We're on the jail host, not setting prompt"
        JAIL_HOST_INSERT=""
        jls
        uptime
    fi

    trick_skel_if_exists_then_alias gmake make
    trick_skel_if_exists_then_alias ghead head
    trick_skel_if_exists_then_alias gtail tail
    trick_skel_if_exists_then_alias gls ls
    trick_skel_if_exists_then_alias grm rm
    trick_skel_if_exists_then_alias gsleep sleep
    trick_skel_if_exists_then_alias gsort sort
    
    export SHELL=/usr/local/bin/bash
    
    # This enables colors with ``ls''
    export CLICOLOR=1

    # w -i sorts by idle time
    alias w='w -i'
fi

if [ -f $HOME/.prompt_message ]; then
    prompt_message=`cat $HOME/.prompt_message`
    PROMPT_MESSAGE_INSERT="[${prompt_message}]"
fi

export PS1="\[\033[${TRICK_USERNAME_COLOR}\]\u\[\033[1;33m\]@\[\033[${TRICK_HOSTNAME_COLOR}\]\h${JAIL_HOST_INSERT}${PROMPT_MESSAGE_INSERT}\[\033[1;33m\]:\[\033[01;34m\]\w\[\033[1;31m\]/\[\033[00m\] "
export PS2='>'
unset TRICK_HOSTNAME_COLOR TRICK_USERNAME_COLOR

# Conditional stuff
# TODO: nested if required because sh whines...wtf?!
if [ -d $HOME/man ]; then if [ "${MANPATH}" != "" ]; then export MANPATH=$MANPATH:$HOME/man; fi; fi

if [ "${OSTYPE}" = "linux-gnu" ]; then
    # Linux-specific stuff goes here
    alias w='w -f'
fi
unset $UNAME

# If we're in a screen session, alias over screen so that we don't end up with a Screen Within A Screen (think: Edgar Allen Poe)
if [ "${TERM}" == "screen" ]; then
    alias 'screen'='echo It appears that you are a masochist. Do not run screen within screen.  It causes cancer.'
fi

trick_skel_verify_ssh_agent

# set up proxy as necessary
trick_skel_proxy

# If we have a hostname specific script in ~/.${host}.sh, run it
if [ -f ${HOME}/.${TRICK_FULL_HOSTNAME}.sh ]; then
    if [ "`head -n 1 ${HOME}/.${TRICK_FULL_HOSTNAME}.sh`" != "# quiet!" ]; then
        echo "Executing .${TRICK_FULL_HOSTNAME}.sh"
    fi
    . ${HOME}/.${TRICK_FULL_HOSTNAME}.sh
fi

trick_h () {
    if [ "$1" -gt 0 &> /dev/null ]; then
        !${1}
    else
        history
    fi
}

skelup () {
    OLD_REV=$TRICK_SKEL_ENV_REVISION
    source ~/.bash_profile_trick_skel
    echo "skelup'd from $OLD_REV to $TRICK_SKEL_ENV_REVISION :)"
    unset OLD_REV
}

unset TRICK_HOSTNAME TRICK_FULL_HOSTNAME TRICK_MOTD

trick_skel_timing_finish
