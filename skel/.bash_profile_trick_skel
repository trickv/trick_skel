#!/usr/bin/env bash

# trickv's bash_profile skeleton
# $Id$

# Should run on any sh-compatible shell if I weren't such a hack, but I am.

TRICK_SKEL_START_TIME=$SECONDS

export PATH=$HOME/bin:$HOME/bin/trick_skel:$PATH

# source all the sh-startup scripts (handled by a previously generated script, initialize)
source $HOME/.trick_skel/initialize

if [ -d $HOME/local/bin ]; then
    export PATH=$HOME/local/bin:$PATH
fi

TRICK_HOSTNAME=${HOSTNAME%%.*}
TRICK_FULL_HOSTNAME=$HOSTNAME

# Handy environment variables that make me happy
export PAGER=less
export EDITOR=vim
export MONO_THEME=clearlooks
# TODO: this is not true on all boxen
export MOZILLA_FIVE_HOME=/usr/lib/seamonkey/
# TODO: this should only be run within certain terminal emulators -- specifically, makes trouble on a linux VT
export CVS_RSH="ssh"
export EMAIL_ADDRESS="trick@vanstaveren.us"
export REAL_NAME="Patrick van Staveren"

# My fancy BASH prompt
# TODO: alternate the color of the username when this is root
# TODO: don't colorize if color isn't available in this terminal.  see system bashrc on any gentoo box
case $TRICK_HOSTNAME in
    anya|willow|sting|baldrick) TRICK_HOSTNAME_COLOR="1;33m";;
    *) TRICK_HOSTNAME_COLOR="1;32m";;
esac
case $UID in
    0) TRICK_USERNAME_COLOR="01;31m";;
    *) TRICK_USERNAME_COLOR="01;37m";;
esac

# If this is a FreeBSD jail host, try and determine the jail host name
if trick_skel_is_freebsd; then
    dbg "Trying to detrmine jail host name..."
    JAIL_HOST=`jailhost`
    dbg "Jail host is '${JAIL_HOST}'"
    if [ "${JAIL_HOST}" != "${TRICK_HOSTNAME}"  -a "${JAIL_HOST}" ]; then
        dbg "We're inside a jail, so setting prompt"
        JAIL_HOST_INSERT="[${JAIL_HOST}]"
        case $JAIL_HOST in
            mustang|camaro|roadrunner)
                TRICK_HOSTNAME_COLOR="1;33m";;
        esac
    else
        dbg "We're on the jail host, not setting prompt"
        JAIL_HOST_INSERT=""
        jls
        uptime
    fi
fi

export PS1="\[\033[${TRICK_USERNAME_COLOR}\]\u\[\033[1;33m\]@\[\033[${TRICK_HOSTNAME_COLOR}\]\h${JAIL_HOST_INSERT}\[\033[1;33m\]:\[\033[01;34m\]\w\[\033[1;31m\]/\[\033[00m\] "
export PS2='>'
unset TRICK_HOSTNAME_COLOR TRICK_USERNAME_COLOR

# set aliases
trick_skel_aliases

# Conditional stuff
# TODO: nested if required because sh whines...wtf?!
if [ -d $HOME/man ]; then if [ "${MANPATH}" != "" ]; then export MANPATH=$MANPATH:$HOME/man; fi; fi

mysql --version 2>&1 | egrep 'Distrib 5' &> /dev/null
if [ $? -eq 0 ]; then
    # this is MySQL 5, use --show-warnings
    alias mysql='mysql --show-warnings'
fi

trick_append_motd () {
    TRICK_MOTD="${TRICK_MOTD}${1}
"
}

trick_motd () {
    echo -n "$TRICK_MOTD"
}

UNAME=`uname`
if [ "${UNAME}" = "FreeBSD" ]; then
    # FreeBSD-specific stuff goes here!
    trick_skel_if_exists_then_alias gmake make
    trick_skel_if_exists_then_alias ghead head
    trick_skel_if_exists_then_alias gtail tail
    trick_skel_if_exists_then_alias gls ls
    trick_skel_if_exists_then_alias grm rm
    trick_skel_if_exists_then_alias gsleep sleep
    trick_skel_if_exists_then_alias gsort sort
    
    export SHELL=/usr/local/bin/bash
    
    # This enables colors with ``ls''
    export CLICOLOR=1

    # w -i sorts by idle time
    alias w='w -i'
fi

if [ "${UNAME}" = "Linux" ]; then
    # Linux-specific stuff goes here
    # FreeBSD lameness: doesn't support --show-progress.  Perhaps fbsd 7 will have bzip 1.0.4?
    alias bzip2='bzip2 --show-progress'
    alias w='w -f'
fi
unset $UNAME

# If we're in a screen session, alias over screen so that we don't end up with a Screen Within A Screen (think: Edgar Allen Poe)
if [ "${TERM}" == "screen" ]; then
    alias 'screen'='echo It appears that you are a masochist. Do not run screen within screen.  It causes cancer.'
fi

trick_skel_verify_ssh_agent

# set up proxy as necessary
trick_skel_proxy

# If we have a hostname specific script in ~/.${host}.sh, run it
if [ -f ${HOME}/.${TRICK_FULL_HOSTNAME}.sh ]; then
    if [ "`head -n 1 ${HOME}/.${TRICK_FULL_HOSTNAME}.sh`" != "# quiet!" ]; then
        echo "Executing .${TRICK_FULL_HOSTNAME}.sh"
    fi
    . ${HOME}/.${TRICK_FULL_HOSTNAME}.sh
fi

trick_h () {
    if [ "$1" -gt 0 &> /dev/null ]; then
        !${1}
    else
        history
    fi
}

skelup () {
    OLD_REV=$TRICK_SKEL_ENV_REVISION
    source ~/.bash_profile_trick_skel
    echo "skelup'd from $OLD_REV to $TRICK_SKEL_ENV_REVISION :)"
    unset OLD_REV
}

export TRICK_SKEL_ENV_REVISION=`cat $HOME/.trick_skel/info/txt | grep '^Last Changed Rev' | cut -d\  -f4`

trick_append_motd "`uptime`"
#trick_motd

#cat $HOME/.trick_skel/motd/*

unset TRICK_HOSTNAME TRICK_FULL_HOSTNAME TRICK_MOTD

trick_skel_timing_finish
