#!/usr/bin/env perl

my $mintelUsProxyCommand = "connect -S localhost:3129 %h %p";

# general use stuff
my %hosts = (
    '*' => {
        'ForwardX11' => 'yes'},
    'svn.gnome.org' => {
        'IdentityFile' => '~/.ssh/trickv@gnome.org/id_rsa',
        'User' => 'trickv'},
    'lish' => {
        'HostName' => 'lish.v9n.us',
        'User' => 'trickv'}
);

my @mintelHosts = qw(atlas diesel bigweld gasket anya willow doobie cartman baldrick raquel bbbx3 bbbx4 cupid lister kryten bunsen beaker narthex mecca maverick goose);

$hostname = `hostname`;
$hostname =~ s/\s+$//g;
my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime();
printf "# ssh config generated for $hostname at %4d-%02d-%02d %02d:%02d:%02d\n\n",
    $year + 1900, $mon + 1, $mday, $hour, $min, $sec;

# global stuff
print "# global settings\n";
print "EscapeChar ^s\n\n";


# special cases for home boxen
if ($hostname =~ /(?:mc|ed).home.vanstaveren.us/) {
    foreach $cur (@mintelHosts) {
        $hosts{$cur} = {'User' => 'pv'};
    }

    $hosts{'atlas'} = {
        'HostName' => 'atlas.home.vanstaveren.us',
        'User' => 'pv' };
    $hosts{'atlas.home.vanstaveren.us'} = {
        'User' => 'pv' };
}

# special cases for atlas
if ($hostname =~ /atlas/) {
    for my $host ( keys %hosts ) {
        $hosts{$host}{'ProxyCommand'} = $mintelUsProxyCommand;
    }
}

# Read the hosts hash and output in a somewhat-standard format
print "# per-host settings\n";
while ( my ($hostname, $properties) = each(%hosts) ) {
    if ($hostname =~ /^$/) {
        $hostname = 'ERROR';
    }
    print "Host $hostname\n";
    while ( my ($property, $value) = each(%$properties) ) {
        if ($value =~ /^$/) {
            $value = 'ERROR';
        }
        print "    $property $value\n";
    }
}

