#!/usr/bin/env bash

INSTALL_DOTFILES=".screenrc .vimrc .bash_profile_trick_skel .colordiffrc .my.cnf.trick_skel .gdbinit .toprc .signature-trick@v.us .colorizerc .cvsrc .gitconfig"

#####

ARCHIVE_DIR=$HOME/tmp/trick_skel_archive

####

echo "Installing in `whoami`@`hostname`..."

# On a fresh home dir, ~/bin does not exist
mkdir -p $HOME/bin/trick_skel $ARCHIVE_DIR

# Archive old files
# First stuff them into a temp dir
mkdir -p $HOME/tmp/trick_skel_backup
echo -n "Archiving "
for cur in $INSTALL_DOTFILES; do
    pushd $HOME > /dev/null
    echo -n "$cur, "
    cp $cur $HOME/tmp/trick_skel_backup
    popd > /dev/null
done
echo
# Then tar 'em up
tar cfj $ARCHIVE_DIR/archive-`date -u "+%Y%m%d-%H%M%S"`.tar.bz2 $HOME/tmp/trick_skel_backup > /dev/null 2>&1 | egrep 'Removing leading'
rm -r $HOME/tmp/trick_skel_backup
# Finally, delete old archives
find $ARCHIVE_DIR -name "archive*" -ctime +10 | xargs -n 10 rm -f

# Install ~/.trick_skel directory
rm -rf $HOME/.trick_skel
cp -R skel/.trick_skel $HOME

# Install .dotfiles
echo -n "Installing: "
for cur in $INSTALL_DOTFILES; do
    echo -n "$cur, "
    cp skel/$cur $HOME/$cur
done
echo

# Install scripts into ~/bin
echo -n "Installing bin files ~/bin/trick_skel: "
rm -f $HOME/bin/trick_skel/*
for cur in `ls skel/bin/`; do
    echo -n "$cur, "
    cp skel/bin/$cur $HOME/bin/trick_skel/$cur
done
echo

# If this is a new installation, add a call to the bash_profile
grep bash_profile_trick_skel $HOME/.bash_profile &> /dev/null
if [ $? -ne 0 ]; then
    echo "Installing bash_profile hook..."
    echo "
# trick's bash_profile script
source ~/.bash_profile_trick_skel" >> $HOME/.bash_profile
fi

# MySQL .my.cnf file generation [magic]
if [ -f $HOME/.my.cnf.local ]; then
    cat $HOME/.my.cnf.local > ~/.my.cnf
    echo >> ~/.my.cnf
    cat $HOME/.my.cnf.trick_skel >> ~/.my.cnf
fi

# Install info on this version of trick_skel
mkdir -p $HOME/.trick_skel/info
svn info &> /dev/null
if [ $? -eq 0 ]; then
    # we have svn and it can read the properties
    svn info --xml > $HOME/.trick_skel/info/xml
    svn info > $HOME/.trick_skel/info/txt
    if [ "`hostname -s`" = "atlas" ]; then
        rm -rf svn-info
        mkdir -p svn-info
        cp $HOME/.trick_skel/info/* svn-info/
    fi
else
    # we don't have svn; see if atlas has already written this info for us
    if [ -d svn-info ]; then
        # we have infos, copy in place
        cp svn-info/* $HOME/.trick_skel/info/
        echo "Installed from svn-info generated by atlas" > $HOME/.trick_skel/info/svn-info-from
    fi
fi

date -u > $HOME/.trick_skel/info/install_date

hostname &> $HOME/.trick_skel/info/install_hostname
hostname -s &> $HOME/.trick_skel/info/install_hostname_short
env &> $HOME/.trick_skel/info/install_env

# install optional scripts depending on conditionals
case "`hostname`" in atlas.usdmm.com|mc.home.vanstaveren.us)
    rm -f $HOME/bin/view
    cp optional/view $HOME/bin/trick_skel/

    rm -f $HOME/bin/myterm_remote
    cp optional/myterm_remote $HOME/bin/trick_skel/

    rm -f $HOME/bin/select-{color,font}
    cp optional/select-{color,font} $HOME/bin/trick_skel/

    rm -f $HOME/bin/gnome-help
    ln -s /bin/true $HOME/bin/trick_skel/gnome-help
esac

if [ "`uname`" = "Linux" ]; then
    rm -f $HOME/bin/lside
    cp optional/lside $HOME/bin/trick_skel/
fi

for cur in `ls install.d`; do
    if [ -x install.d/$cur ]; then
        echo Running install.d/$cur
        install.d/$cur
    fi
done

# Viola!
echo "Done."
